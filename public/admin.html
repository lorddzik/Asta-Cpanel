<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - Asta Panel ü¶Ö</title>
  <meta name="theme-color" content="#e6f0ff"/>
  <link rel="icon" href="https://files.catbox.moe/bzkzuc.jpg" />
  <script>
    (function(){
      try {
        const stored = localStorage.getItem('theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = stored || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      } catch (e) {}
    })();
  </script>
</head>
<style>
  :root { --bg-overlay: rgba(255, 255, 255, 0.6); --bg-gradient: linear-gradient(180deg, #eef6ff, #ffffff 40%); --card-bg: #ffffff; --text-primary: #0f172a; --text-secondary: #475569; --brand: #2563eb; --brand-strong: #1d4ed8; --ring: rgba(37, 99, 235, 0.35); --border: rgba(2,6,23,0.12); --input-bg: #ffffff; --shadow: 0 10px 24px rgba(2, 6, 23, 0.06); --success: #22c55e; --error: #ef4444; }
    [data-theme="dark"] { --bg-overlay: rgba(0, 0, 0, 0.5); --bg-gradient: linear-gradient(180deg, #0b1220, #0b1220 40%); --card-bg: rgba(17, 24, 39, 0.7); --text-primary: #e2e8f0; --text-secondary: #94a3b8; --ring: rgba(99, 102, 241, 0.35); --border: rgba(255,255,255,0.14); --input-bg: rgba(148,163,184,0.08); --shadow: 0 12px 30px rgba(0,0,0,0.35); }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: url('https://files.catbox.moe/bzkzuc.jpg') center/cover no-repeat fixed, var(--bg-gradient); min-height: 100vh; display: flex; flex-direction: column; color: var(--text-primary); transition: padding-left 0.3s ease; }
    .overlay { position: fixed; width: 100%; height: 100%; inset: 0; backdrop-filter: blur(6px); background-color: var(--bg-overlay); z-index: 0; pointer-events: none; }
    header { position: relative; z-index: 10; background: rgba(255,255,255,0.8); padding: 18px 20px; display: flex; align-items: center; justify-content: center; gap: 12px; border-bottom: 1px solid rgba(15,23,42,0.06); backdrop-filter: saturate(160%) blur(6px); }
    [data-theme="dark"] header { background: rgba(0,0,0,0.4); border-bottom: 1px solid rgba(255,255,255,0.08); }
    .logo { width: 28px; height: 28px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.35); }
    main { flex: 1; display: flex; justify-content: center; align-items: flex-start; padding: 24px; position: relative; z-index: 1; }
    .card { background: var(--card-bg); padding: 32px 30px; border-radius: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); width: 100%; max-width: 480px; color: var(--text-primary); }
    .card h2 { margin-top: 0; text-align: center; }
    .form-group { margin-bottom: 16px; }
    .role-group { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    .role-btn { border: 1px solid var(--border); background: var(--card-bg); color: var(--text-primary); padding: 10px 12px; border-radius: 12px; cursor: pointer; height: auto; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600; }
    .role-btn:hover { border-color: var(--brand-strong); }
    .role-btn[aria-pressed="true"] { outline: none; border-color: var(--brand-strong); box-shadow: 0 0 0 4px var(--ring); }
    .role-helper { margin-top: 8px; color: var(--text-secondary); font-size: 12px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: var(--text-secondary); }
    .form-group input, .form-group button { box-sizing: border-box; width: 100%; height: 46px; padding: 0 14px; border: 1px solid var(--border); border-radius: 12px; outline: none; font-size: 14px; transition: all 0.2s ease; }
    .form-group input { background-color: var(--input-bg); color: var(--text-primary); }
    .form-group input:focus { border-color: var(--brand-strong); box-shadow: 0 0 0 4px var(--ring); }
    .form-group button { background: linear-gradient(135deg, var(--brand), var(--brand-strong)); color: #ffffff; cursor: pointer; border: none; font-weight: 600; }
    .form-group button:disabled { background: var(--text-secondary); cursor: not-allowed; }
    .user-list { list-style: none; padding: 0; margin-top: 24px; }
    .user-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); }
    .user-item:last-child { border-bottom: none; }
    .delete-btn { background: var(--error); color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; }
    #notification-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background-color: var(--card-bg); color: var(--text-primary); padding: 15px 20px; border-radius: 12px; box-shadow: var(--shadow); border-left: 5px solid; opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); min-width: 280px; }
    .toast.show { opacity: 1; transform: translateX(0); }
    .toast.success { border-color: var(--success); }
    .toast.error { border-color: var(--error); }
    .theme-toggle { background: transparent; border: 1px solid var(--border); color: var(--text-primary); padding: 8px 12px; border-radius: 10px; cursor: pointer; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); display: inline-flex; align-items: center; gap: 6px; }
    .theme-toggle:hover { border-color: var(--brand-strong); }
    .role-badge { position:absolute; left: 80px; top: 50%; transform: translateY(-50%); background: rgba(37,99,235,0.12); color: var(--text-primary); border: 1px solid var(--border); padding: 6px 10px; border-radius: 10px; font-size: 12px; }
    footer { position: relative; z-index: 1; color: var(--text-secondary); text-align: center; font-size: 12px; padding: 14px 10px 20px; }
    
    /* Sidebar Styles */
    .sidebar { height: 100%; width: 250px; position: fixed; z-index: 1001; top: 0; left: 0; background-color: var(--card-bg); overflow-x: hidden; transition: 0.3s; transform: translateX(-250px); padding-top: 60px; box-shadow: var(--shadow); border-right: 1px solid var(--border); }
    .sidebar.open { transform: translateX(0); }
    .sidebar a { padding: 10px 15px; text-decoration: none; font-size: 18px; color: var(--text-primary); display: flex; align-items: center; gap: 15px; transition: 0.2s; border-radius: 8px; margin: 5px 10px; }
    .sidebar a:hover { background-color: var(--brand); color: white; }
    .sidebar .close-btn { position: absolute; top: 10px; right: 15px; font-size: 36px; background: none; border: none; color: var(--text-primary); cursor: pointer; }
    .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    .sidebar-overlay.show { opacity: 1; pointer-events: auto; }
    .header-btn { background: transparent; border: 1px solid var(--border); color: var(--text-primary); padding: 8px 12px; border-radius: 10px; cursor: pointer; position: absolute; top: 50%; transform: translateY(-50%); font-size: 18px; }

</style>
<body>
  <div id="sidebar-overlay" class="sidebar-overlay"></div>
  <nav id="sidebar" class="sidebar">
    <button id="sidebar-close-btn" class="close-btn">&times;</button>
    <a href="/panel"><span class="icon">üìä</span> Buat Panel</a>
    <a href="/users" id="manage-users-link" style="display: none;"><span class="icon">üë•</span> Kelola Pengguna</a> 
    <a href="#" id="sidebar-logout-btn"><span class="icon">üö™</span> Keluar</a>
  </nav>

  <div id="notification-container"></div>
  <div class="overlay"></div>
  <header>
    <button id="menu-btn" class="header-btn" style="left: 20px;">&#9776;</button>
    <img class="logo" src="https://files.catbox.moe/bzkzuc.jpg" alt="Logo"/>
    <span id="role-badge" class="role-badge" style="display:none"></span>
    <div style="font-size: 22px; font-weight: 700;">Asta Panel ü¶Ö - Admin</div>
    <button id="theme-toggle" class="theme-toggle" type="button" aria-pressed="false" title="Ganti tema">
      <span id="theme-icon" aria-hidden="true">üåô</span>
    </button>
  </header>
  <main>
    <div class="card">
      <section id="add-user-section">
        <h2>Tambah Pengguna Baru</h2>
        <form id="add-user-form">
          <div class="form-group">
            <label for="new-username">Username</label>
            <input type="text" id="new-username" placeholder="Username baru" required />
          </div>
          <div class="form-group">
            <label>Pilih Peran Pengguna</label>
            <div id="role-group" class="role-group" role="group" aria-label="Pilih peran">
              <button type="button" class="role-btn" data-role="tangan_kanan" aria-pressed="false">Tangan Kanan</button>
              <button type="button" class="role-btn" data-role="owner" aria-pressed="false">Owner Panel</button>
              <button type="button" class="role-btn" data-role="partner" aria-pressed="false">Partner Panel</button>
              <button type="button" class="role-btn" data-role="admin_panel" aria-pressed="false">Admin Panel</button>
              <button type="button" class="role-btn" data-role="reseller" aria-pressed="false">Reseller Panel</button>
            </div>
            <div class="role-helper">Catatan: <b>Admin Panel</b> berbeda dengan <b>Admin Website</b>. Admin Panel hanya memiliki hak mengelola panel (pengguna/layanan), bukan hak administratif website (server, konfigurasi aplikasi, dll). Pilih sesuai kebutuhan.</div>
            <div id="role-error" class="toast error" style="position: static; transform:none; opacity:1; display:none; margin-top:10px;">Silakan pilih peran pengguna.</div>
          </div>
          <div class="form-group">
            <label for="telegram-id">ID Telegram (Untuk Kirim Datanya)</label>
            <input type="text" id="telegram-id" placeholder="Masukkan ID" required />
            <div class="role-helper">Detail akun akan dikirim ke ID ini.</div>
          </div>
          <div class="form-group">
            <label>Password</label>
            <div class="role-helper">Password akan dibuat otomatis dari username + 3 angka acak. Anda tidak perlu mengisi password.</div>
          </div>
          <div class="form-group">
            <button type="submit" id="add-user-btn">Tambah Pengguna</button>
          </div>
        </form>
      </section>
      
      </div>
  </main>
  <footer>¬© <span id="y"></span> Asta Panel ü¶Ö ¬∑ Dibuat dengan ‚ù§</footer>
  <script>
    
    document.getElementById('y').textContent = new Date().getFullYear();
const metaTheme = document.querySelector('meta[name="theme-color"]');
const themeToggleBtn = document.getElementById('theme-toggle');
const themeIcon = document.getElementById('theme-icon');

function applyThemeUI(theme) {
  const isDark = theme === 'dark';
  themeToggleBtn.setAttribute('aria-pressed', String(isDark));
  themeIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  if (metaTheme) metaTheme.setAttribute('content', isDark ? '#0b1220' : '#e6f0ff');
}

function getCurrentTheme() {
  return document.documentElement.getAttribute('data-theme') || 'light';
}

function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  try { localStorage.setItem('theme', theme); } catch (e) {}
  applyThemeUI(theme);
}

applyThemeUI(getCurrentTheme());
themeToggleBtn.addEventListener('click', function(){
  const current = getCurrentTheme();
  const next = current === 'dark' ? 'light' : 'dark';
  setTheme(next);
});

// Gate akses: izinkan admin website ATAU pengguna dengan creatorRole valid
const adminAuthed = sessionStorage.getItem('adminAuth') === 'true';
let creatorRole = sessionStorage.getItem('creatorRole');
if (!adminAuthed && (!creatorRole || creatorRole === '')) {
  window.location.href = '/';
}

const addUserForm = document.getElementById('add-user-form');
const addUserBtn = document.getElementById('add-user-btn');
const roleGroup = document.getElementById('role-group');
const roleError = document.getElementById('role-error');
let selectedRole = '';

if (sessionStorage.getItem('adminAuth') === 'true' && (!creatorRole || creatorRole === '')) {
  sessionStorage.setItem('creatorRole', 'admin_website');
  creatorRole = 'admin_website';
}

const roleBadge = document.getElementById('role-badge');
roleBadge.textContent = (creatorRole || '').replace(/_/g,' ').toUpperCase();
roleBadge.style.display = 'inline-block';

function showToast(message, type = 'success') {
  const container = document.getElementById('notification-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 100);
  setTimeout(() => {
    toast.classList.remove('show');
    toast.addEventListener('transitionend', () => toast.remove());
  }, 5000);
}

const ROLE_ORDER = ['tangan_kanan', 'owner', 'partner', 'admin_panel', 'reseller'];
function applyRoleAvailability() {
  const current = creatorRole || 'reseller';
  let allowFromIndex = ROLE_ORDER.length; 
  if (current === 'admin_website') {
    allowFromIndex = 0;
  } else {
    const idx = ROLE_ORDER.indexOf(current);
    allowFromIndex = idx >= 0 ? idx + 1 : ROLE_ORDER.length;
  }
  Array.from(roleGroup.querySelectorAll('.role-btn')).forEach((btn) => {
    const r = btn.dataset.role;
    const rIdx = ROLE_ORDER.indexOf(r);
    const allowed = rIdx >= allowFromIndex;
    btn.disabled = !allowed;
    btn.style.opacity = allowed ? '1' : '0.5';
    btn.title = allowed ? '' : 'Tidak memiliki izin membuat peran ini';
  });
}
applyRoleAvailability();

roleGroup.addEventListener('click', (e) => {
  const btn = e.target.closest('.role-btn');
  if (!btn || btn.disabled) return;
  selectedRole = btn.dataset.role;
  Array.from(roleGroup.querySelectorAll('.role-btn')).forEach(b => b.setAttribute('aria-pressed', String(b === btn)));
  roleError.style.display = 'none';
});

function generatePasswordFromUsername(name) {
  const base = name.replace(/\s+/g, '');
  const rand = Math.floor(100 + Math.random() * 900);
  return `${base}${rand}`;
}

// Ganti addUserForm.addEventListener di admin.html dengan ini
addUserForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const username = document.getElementById('new-username').value.trim();
  const telegramId = document.getElementById('telegram-id').value.trim(); // Ambil ID Telegram
  const password = generatePasswordFromUsername(username);
  if (!selectedRole) { roleError.style.display = 'block'; return; }
  if (!telegramId) { showToast('ID Telegram wajib diisi!', 'error'); return; }

  addUserBtn.disabled = true;
  addUserBtn.textContent = 'Menambahkan...';

  try {
    const response = await fetch('/api/adduser', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password, role: selectedRole, creatorRole, telegramId }), // Kirim telegramId
    });
    const data = await response.json();
    showToast(response.ok ? `User berhasil dibuat.\nNotifikasi dikirim ke ${telegramId}` : (data.message || 'Gagal menambah pengguna.'), response.ok ? 'success' : 'error');
    if (response.ok) {
      addUserForm.reset();
      selectedRole = '';
      Array.from(roleGroup.querySelectorAll('.role-btn')).forEach(b => b.setAttribute('aria-pressed', 'false'));
    }
  } catch (err) {
    showToast('Terjadi kesalahan jaringan.', 'error');
  } finally {
    addUserBtn.disabled = false;
    addUserBtn.textContent = 'Tambah Pengguna';
  }
});

// Sidebar Logic
const menuBtn = document.getElementById('menu-btn');
const sidebar = document.getElementById('sidebar');
const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
const overlay = document.getElementById('sidebar-overlay');
const logoutBtn = document.getElementById('sidebar-logout-btn');

function openSidebar() {
  sidebar.classList.add('open');
  overlay.classList.add('show');
}

function closeSidebar() {
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
}

menuBtn.addEventListener('click', openSidebar);
sidebarCloseBtn.addEventListener('click', closeSidebar);
overlay.addEventListener('click', closeSidebar);

logoutBtn.addEventListener('click', (e) => {
    e.preventDefault();
    sessionStorage.removeItem('adminAuth');
    sessionStorage.removeItem('creatorRole');
    window.location.href = '/';
});

document.addEventListener('DOMContentLoaded', () => {
    // Logika untuk menampilkan link Kelola Pengguna di sidebar
    const manageUsersLink = document.getElementById('manage-users-link');
    if (sessionStorage.getItem('creatorRole') === 'admin_website') {
        manageUsersLink.style.display = 'flex'; // Gunakan 'flex' karena item sidebar adalah flexbox
    }
});
  </script>
</body>
</html>